@using WebProject.Core.Models
@using Microsoft.AspNetCore.Components
@using System.ComponentModel
@using System.ComponentModel.DataAnnotations
@using System.Globalization
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using WebProject.Core.Interfaces
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider _authenticationStateProvider
@inject UserManager<ApplicationUser> _userManager;
@inject IEntityRepository<Listing> _listingRepository;
@inject IEntityRepository<ListingCategory> _categoryRepository

<EditForm EditContext="@_editContext" class="row g-5" OnValidSubmit="CreateListing">
    <DataAnnotationsValidator/>
    <div class="col-md-5 col-lg-4 order-sm-first order-md-last">
        <FileUpload Images="@_input.Images" User="_user"/>
    </div>
    <div class="col-md-7 col-lg-8">
        <h4 class="mb-3">Izveidot sludinājumu</h4>
        <div class="row g-3">
            <div class="col-12">
                <label for="listingTitle">Virsraksts</label>
                <InputText @bind-Value="@_input.Title" class="form-control" id="listingTitle"/>
                <ValidationMessage class="text-danger" For="@(() => _input.Title)"/>
            </div>
            <div class="col-12">
                <label for="listingDesc">Apraksts</label>
                <InputTextArea id="listingDesc" @bind-Value="@_input.Description" class="form-control" style="height: 120px;"/>
                <ValidationMessage For="@(() => _input.Description)"/>
            </div>
            <div class="col-4">
                <label for="listingPrice">Cena</label>
                <InputText id="listingPrice" @bind-Value="@_input.PriceInput" class="form-control" placeholder="Price"/>
                <ValidationMessage For="@(() => _input.Price)"/>
            </div>
            <div class="col-8">
                <label for="listingCategory">Kategorija</label>
                <CategoryDropdown Id="listingCategory" @bind-Category="_input.Category" @bind-Category:event="SelectedCategoryChanged"/>
                <ValidationMessage For="@(() => _input.Category)"/>
            </div>
        </div>
        <hr class="my-4">
        <button class="w-100 btn btn-primary btn-lg" type="submit">Izveidot</button>
    </div>
</EditForm>
@code {
    private CreateListingModel _input { get; set; } = new ();
    private EditContext _editContext;
    private ApplicationUser _user { get; set; }
    protected int _selectedCategoryId { get; set; }
    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(_input);
        var authState = await _authenticationStateProvider.GetAuthenticationStateAsync();
        var userClaim = authState.User;
        _user = await _userManager.GetUserAsync(userClaim);
        if (userClaim.Identity is null || !userClaim.Identity.IsAuthenticated || _user is null)
        {
            NavigationManager.NavigateTo("/Account/Login");
        }
    }
    private async Task CreateListing(EditContext context)
    {
        var listing = new Listing()
        {
            Description = _input.Description,
            Title = _input.Title,
            Images = _input.Images,
            CreatedBy = _user,
            Created = DateTime.UtcNow,
            Price = _input.Price,
            Category = _input.Category
        };
        listing.Images.ForEach(i => i.Listing = listing);

        await _listingRepository.Add(listing);
        NavigationManager.NavigateTo($"/Listings/Index/{listing.ListingUrlId}", true, true);
    }
    private class CreateListingModel
    {
        [Required(ErrorMessage = "Virsraksts ir nepieciešams")]
        [MinLength(8, ErrorMessage = "Virsraksts nav pietiekami garš")]
        [DisplayName("Virsraksts")]
        public string Title { get; set; } = string.Empty;

        [Required(ErrorMessage = "Apraksts ir nepieciešams")]
        [MinLength(20, ErrorMessage = "Apraksts nav pietiekami garš")]
        [DisplayName("Apraksts")]
        public string Description { get; set; } = string.Empty;

        [Required(ErrorMessage = "Cena ir nepieciešama")]
        [DisplayFormat(DataFormatString = "2dp")]
        public float Price { get; set; } = 0;
        
        [Required(ErrorMessage = "Kategorija ir nepieciešama!")]
        public ListingCategory Category { get; set; } = null!;

        public string PriceInput
        {
            get => Price.ToString("C", new CultureInfo("lv-LV"));
            set => Price = float.TryParse(value.Replace('.',','), NumberStyles.Currency, new CultureInfo("lv-LV"), out float output) ? (float)Math.Round(output, 2) : 0f;
        }
        [MinLength(1, ErrorMessage = "Nepieciešams vismaz viens attēls")]
        public List<ListingImage> Images { get; set; } = new List<ListingImage>();
    }
}